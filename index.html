<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Monopoly Sala de Espera – Online</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/socket.io/socket.io.js"></script>
  <style>
    html,body{background:#181a1b;color:#eee;font-family:'Century Gothic',sans-serif;}
    .token{transition:all 0.3s cubic-bezier(.68,-0.55,.27,1.55);position:absolute;
      width:32px;height:32px;border-radius:50%;box-shadow:0 2px 6px #0004;
      text-align:center;line-height:32px;font-weight:bold;font-size:1.2em;
      color:#fff;border:2px solid #fff;}
    .token.p0{background:#fc0;}
    .token.p1{background:#06f;}
    .token.p2{background:#e00;}
    .token.p3{background:#397;}
    .token.p4{background:#ff6;}
    .token.p5{background:#0fa;}
    .pos-tile{
      position:absolute;width:60px;height:60px;border:1px solid #444;background:#232729;
      border-radius:10px;display:flex;align-items:center;justify-content:center;
      color:#eee;font-size:0.85em;box-shadow:0 2px 18px #0006;}
    .tile-special{background:#2f3140;color:#3cf;}
    ::selection{background:#0cf3;}
  </style>
</head>
<body class="bg-[#181a1b] min-h-screen flex items-center justify-center">
  <div class="max-w-4xl mx-auto w-full bg-[#232729] shadow-lg rounded-lg p-8 relative">

    <!-- Lobby principal -->
    <div id="lobby">
      <h1 class="text-4xl font-bold mb-6 text-center">Monopoly <span class="text-blue-300">Online</span></h1>
      <div class="flex flex-col gap-4 max-w-sm mx-auto mb-10">
        <input id="playerName" class="border px-4 py-2 rounded bg-[#181a1b] text-[#eee] border-[#555]" placeholder="Tu nombre" maxlength="16" />
        <input id="roomCode" class="border px-4 py-2 rounded bg-[#181a1b] text-[#eee] border-[#555] uppercase" placeholder="Código sala" maxlength="8" />
        <button id="joinBtn" class="bg-blue-600 text-white font-bold px-4 py-2 rounded shadow hover:bg-blue-700">Entrar/Crear Sala</button>
      </div>
      <div id="salasPanel" class="mb-8"></div>
      <div id="lobbyNote" class="text-[#aaa] text-center"></div>
    </div>

    <!-- Sala de espera -->
    <div id="waitingRoom" class="hidden mt-6">
      <h2 class="text-2xl font-bold mb-2 text-blue-300">Sala <span id="currentRoom"></span></h2>
      <div class="mb-2">Jugadores en la sala:</div>
      <ul id="playerList" class="mb-4"></ul>
      <button id="readyBtn" class="bg-purple-600 text-white font-bold px-3 py-2 rounded shadow hover:bg-purple-700">¡Listo!</button>
      <span id="readyIndicator" class="ml-2 text-green-400 font-bold hidden">Esperando jugadores...</span>
      <button id="startBtn" class="bg-green-700 text-white font-bold px-4 py-2 rounded shadow hover:bg-green-600 hidden">Empezar partida</button>
      <button onclick="location.reload()" class="mt-3 underline text-[#73f] block">Salir y Volver</button>
    </div>

    <!-- Juego Monopoly -->
    <div id="gameBoard" class="hidden mt-8">
      <h2 class="text-xl font-bold mb-4 text-blue-100">Partida Monopoly — Sala <span id="roomGame"></span></h2>
      <div id="playersInfo" class="mb-6"></div>
      <div id="boardParent" class="flex justify-center">
        <div id="board" class="relative"
          style="width:730px;height:402px;background:#181a1b;border:2px solid #333;box-shadow:0 8px 32px #000a;border-radius:16px;"></div>
      </div>
      <div id="gameActions" class="mt-8 flex flex-col items-center gap-2">
        <button id="rollBtn" class="bg-yellow-500 text-black px-6 py-2 rounded font-bold shadow hover:bg-yellow-600 text-xl">Tirar dado</button>
        <div id="gameMsg" class="mt-2 text-lg font-bold text-center"></div>
      </div>
      <button onclick="location.reload()" class="mt-8 underline text-blue-400">Salir y Volver</button>
    </div>
  </div>
  <script>
    // Tablero demo (20 casillas, expándelo si quieres real)
    const boardTiles = [
      {x:0,y:0,name:"Salida"},{x:1,y:0,name:"Calle 1",$:60},{x:2,y:0,name:"Suerte",special:1},{x:3,y:0,name:"Calle 2",$:80},
      {x:4,y:0,name:"Impuesto",special:1},{x:5,y:0,name:"Calle 3",$:90},{x:5,y:1,name:"Calle 4",$:100},{x:5,y:2,name:"Comunidad",special:1},
      {x:5,y:3,name:"Calle 5",$:110},{x:5,y:4,name:"Cárcel",special:1},{x:4,y:4,name:"Calle 6",$:120},{x:3,y:4,name:"Suerte",special:1},
      {x:2,y:4,name:"Calle 7",$:130},{x:1,y:4,name:"Calle 8",$:140},{x:0,y:4,name:"Parking",special:1},{x:0,y:3,name:"Calle 9",$:150},
      {x:0,y:2,name:"Calle10",$:160},{x:0,y:1,name:"Comunidad",special:1},{x:2,y:2,name:"Calle 11",$:180},{x:3,y:2,name:"Calle 12",$:200}
    ];

    // SOCKET.IO & lógica salas
    const socket = io();
    const lobbyDiv = document.getElementById('lobby');
    const salasPanel = document.getElementById('salasPanel');
    const waitingRoomDiv = document.getElementById('waitingRoom');
    const playerList = document.getElementById('playerList');
    const currentRoomSpan = document.getElementById('currentRoom');
    const readyBtn = document.getElementById('readyBtn');
    const readyIndicator = document.getElementById('readyIndicator');
    const startBtn = document.getElementById('startBtn');
    const gameBoardDiv = document.getElementById('gameBoard');
    const roomGameSpan = document.getElementById('roomGame');
    const playersInfoDiv = document.getElementById('playersInfo');
    const rollBtn = document.getElementById('rollBtn');
    const gameMsgDiv = document.getElementById('gameMsg');
    const boardDiv = document.getElementById('board');
    let myName = "", myRoom = "", isReady=false, gameState=null, mySocketId=null;

    function actualizarSalasPanel(salas) {
      if(!salas || !salas.length) {
        salasPanel.innerHTML = `<div class="text-[#888] text-sm text-center">No hay salas activas. Inicia una nueva con tu código.</div>`;
        return;
      }
      salasPanel.innerHTML = `<div class="mb-2 text-[#ccc] text-center font-mono text-xs">Salas activas:</div>` +
        salas.map(s => `<div class="px-1 py-1"><span class="text-blue-400">${s.id}</span> (${s.players.length}/${s.maxPlayers})</div>`).join("");
    }
    socket.on('roomsUpdate', actualizarSalasPanel);

    document.getElementById('joinBtn').onclick = () => {
      myName = document.getElementById('playerName').value.trim();
      myRoom = document.getElementById('roomCode').value.trim().toUpperCase();
      if (!myName || !myRoom) return alert("Debes poner tu nombre y código de sala.");
      socket.emit('joinRoom', { roomId: myRoom, name: myName }, (ok, roomInfo) => {
        if (ok) showWaitingRoom(roomInfo);
        else socket.emit('createRoom', { name: myName, maxPlayers: 6 }, (newId, info) => {
          myRoom = newId;
          showWaitingRoom(info);
        });
      });
    };

    socket.on('roomUpdate', showWaitingRoom);

    function showWaitingRoom(roomInfo) {
      mySocketId = socket.id;
      lobbyDiv.classList.add('hidden');
      waitingRoomDiv.classList.remove('hidden');
      currentRoomSpan.textContent = roomInfo.id;
      readyBtn.classList.remove('hidden');
      readyIndicator.classList.add('hidden');
      playerList.innerHTML = "";
      let readyCount = 0;
      roomInfo.players.forEach(p => {
        let readyTag = p.ready ? `<span class="ml-2 text-green-400 text-xs font-bold">✔</span>` : "";
        if (p.ready) readyCount++;
        playerList.innerHTML += `<li>${p.name}${roomInfo.host===p.id ? ' <span class="text-purple-400">(Host)</span>':''}${readyTag}</li>`;
      });
      if (roomInfo.players.length > 1 && roomInfo.host === mySocketId && readyCount === roomInfo.players.length) {
        startBtn.classList.remove('hidden');
      } else {
        startBtn.classList.add('hidden');
      }
    }
    readyBtn.onclick = () => {
      readyBtn.classList.add('hidden');
      readyIndicator.classList.remove('hidden');
      isReady=true;
      socket.emit('markReady', { roomId: myRoom, ready: true });
    };
    startBtn.onclick = () => { socket.emit('startGame', { roomId: myRoom }); };

    socket.on('gameStart', state => {
      waitingRoomDiv.classList.add('hidden');
      gameBoardDiv.classList.remove('hidden');
      roomGameSpan.textContent = myRoom;
      gameState = state;
      renderGameState();
    });

    rollBtn.onclick = () => {
      const me = gameState.players.find(p=>p.id===mySocketId);
      if (gameState.players[gameState.turn].id !== mySocketId) {
        gameMsgDiv.textContent = "No es tu turno";
        return;
      }
      rollBtn.disabled=true;
      setTimeout(()=>{
        let roll = Math.floor(Math.random()*6+1) + Math.floor(Math.random()*6+1);
        socket.emit('syncAction', { roomId: myRoom, action: {type:"roll",value:roll}});
        rollBtn.disabled=false;
      },600);
    };
    socket.on('syncAction', action => {
      if (action.type === "roll") {
        let curr = gameState.players[gameState.turn];
        let oldPos = curr.pos;
        curr.pos = (curr.pos+action.value)%boardTiles.length;
        animateToken(gameState.turn, oldPos, curr.pos,() => {
          gameMsgDiv.innerHTML = `<span class="text-yellow-300">${curr.name}</span> avanza a <span class="text-blue-300">"${boardTiles[curr.pos].name}"</span> con <b>${action.value}</b>.`;
        });
        gameState.lastRoll = action.value;
        gameState.turn = (gameState.turn+1)%gameState.players.length;
        renderGameState();
      }
    });
    function renderGameState() {
      playersInfoDiv.innerHTML = gameState.players.map((player,i)=>
        `<span class="px-2 rounded font-bold ${i==gameState.turn?"bg-blue-900 text-white":""}" style="display:inline-block">
          ${player.name} <span class="text-yellow-400">$${player.money}</span>
          <span class="ml-2">${boardTiles[player.pos].name}</span>
        </span>`
      ).join(" ");
      gameMsgDiv.innerHTML = `<span class="text-blue-200">Turno de</span> <b>${gameState.players[gameState.turn].name}</b>`;
      renderBoardAndTokens();
    }
    function renderBoardAndTokens() {
      boardDiv.innerHTML = "";
      boardTiles.forEach((tile,i)=>{
        let l=tile.x*36+20,t=tile.y*72+24;
        boardDiv.innerHTML += `<div class="pos-tile absolute ${tile.special?'tile-special':''}" style="left:${l}px;top:${t}px;">
          <div class="font-bold">${tile.name}</div>
          ${tile.$ ? `<div class="text-xs text-yellow-300 font-mono">\$${tile.$}</div>`:""}
        </div>`;
      });
      gameState.players.forEach((p,i)=>{ placeTokenAnimated(i,p.pos); });
    }
    function placeTokenAnimated(idx,pos) {
      const tile = boardTiles[pos];
      if (!tile) return;
      const tokenId = 'token'+idx;
      let oldToken = document.getElementById(tokenId);
      let l=tile.x*36+42, t=tile.y*72+30+(idx*6);
      if(!oldToken) {
        let token = document.createElement('div');
        token.id = tokenId;
        token.className = 'token p'+(idx%8);
        token.innerText = String.fromCharCode(65+idx);
        token.style.left = l+'px';
        token.style.top = t+'px';
        boardDiv.appendChild(token);
      } else {
        oldToken.style.left = l+'px';
        oldToken.style.top = t+'px';
      }
    }
    function animateToken(idx, from, to, cb) {
      let steps = ((to-from+boardTiles.length)%boardTiles.length)||1;
      let curr = from, count=0;
      let interval = setInterval(()=>{
        curr = (curr+1)%boardTiles.length;
        placeTokenAnimated(idx,curr);
        if(++count>=steps) {
          clearInterval(interval); cb&&cb();
        }
      }, 120);
    }
  </script>
</body>
</html>
